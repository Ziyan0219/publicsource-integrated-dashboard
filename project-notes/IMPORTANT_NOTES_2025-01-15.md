# Important Notes - Geographic Classification System

## Date: 2025-01-15

## Critical Issues Discovered and Fixed

### 1. **Classification Logic Mismatch Between Code and Existing Data**

**Problem:**
- The existing `stories.json` database contained **incorrect** geographic classifications
- Municipalities (e.g., Sewickley, Braddock, Clairton) were placed in the `neighborhoods` field
- However, these are **NOT** Pittsburgh neighborhoods - they are Allegheny County municipalities
- The classification code was NOT putting municipalities in the neighborhoods field

**Root Cause:**
- Previous data may have been manually edited or generated by different logic
- The `archive_classifier_final.py` code (lines 531-535) only put Pittsburgh neighborhoods in the Neighborhoods field
- Municipalities went to the Umbrella field instead

**Fix Applied:**
- Modified `archive_classifier_final.py` (lines 534-540) to include municipalities in Neighborhoods field when no Pittsburgh neighborhoods are found
- Updated Umbrella field logic (lines 553-561) to use "Allegheny County" when municipalities are used as neighborhoods

### 2. **Working Directory Issue in Testing Tool**

**Problem:**
- The testing tool was failing to load `enhanced_geographic_data.json`
- This caused classification to fall back to basic mode with empty results
- Geographic Area and Neighborhoods were showing as "not detected" or "N/A"

**Root Cause:**
- Test scripts were running from `testing-tool/` directory
- But `enhanced_geographic_data.json` is in the project root directory
- Relative file paths failed

**Fix Applied:**
- Added `os.chdir(project_root)` in `testing-tool/backend/test_api.py` (line 25)
- Added `os.chdir(str(project_root))` in `testing-tool/test_classification.py` (line 12)
- Both now run from project root directory

### 3. **Correct Geographic Hierarchy Structure**

**The correct 3-level hierarchy is:**

```
Umbrella (Top Level)
  └── Geographic Area (Middle Level)
        └── Neighborhoods (Bottom Level)
```

**For Municipality-based Articles (e.g., Sewickley):**
- **Umbrella**: "Allegheny County"
- **Geographic Area**: "Northwest Suburbs" (the municipality's sub_region from enhanced_geographic_data.json)
- **Neighborhoods**: "SEWICKLEY, LEET, FOX CHAPEL, ..." (specific municipality names)

**For Pittsburgh Neighborhood-based Articles (e.g., Lawrenceville):**
- **Umbrella**: "Pittsburgh, Allegheny County" or region with "County" in name
- **Geographic Area**: "East End" (the neighborhood's region from enhanced_geographic_data.json)
- **Neighborhoods**: "Lawrenceville, Bloomfield, ..." (specific Pittsburgh neighborhood names)

### 4. **Geographic Data Structure in enhanced_geographic_data.json**

**Two separate geographic systems exist:**

1. **Pittsburgh Neighborhoods** (90 total)
   - Have a `region` field (e.g., "North Side", "South Pittsburgh", "East End")
   - Defined in `pittsburgh_neighborhoods` section
   - Regions listed in `pittsburgh_regions` section (lines 364-470)

2. **Allegheny County Municipalities** (127 total)
   - Have a `sub_region` field (e.g., "Northwest suburbs", "North Hills", "Mon Valley")
   - Defined in `allegheny_county_municipalities` section
   - Sub-regions listed in `allegheny_county_sub_regions` section (lines 1744+)

**Key Finding:**
- These are **separate systems** - municipalities are NOT Pittsburgh neighborhoods
- Previous data mixing them together was incorrect
- Code now handles both correctly with proper hierarchy

### 5. **Advanced Geographic Classifier**

**Two classification engines exist:**

1. **`archive_classifier_final.py`** - Main pipeline
   - Orchestrates the classification process
   - Handles file I/O, caching, and data transformation
   - Assigns results to Umbrella, GeographicArea, Neighborhoods fields

2. **`advanced_geographic_classifier.py`** - NLP classification engine
   - Multi-layer NLP analysis using spaCy, sentence transformers, ML classifiers
   - Returns detected places and confidence scores
   - Does NOT decide which field each place goes to
   - Called by `archive_classifier_final.py` at line 444

**The pipeline uses the advanced classifier if available, otherwise falls back to basic pattern matching.**

## Code Changes Made

### File: `archive_classifier_final.py`

**Lines 534-540** - Allow municipalities in Neighborhoods field:
```python
# Put both neighborhoods AND municipalities in the Neighborhoods field
# Prioritize Pittsburgh neighborhoods, but include municipalities if no neighborhoods found
if neighborhoods:
    df.at[idx, "Neighborhoods"] = ", ".join(neighborhoods)
elif municipalities:
    # If no Pittsburgh neighborhoods found, use municipalities as neighborhoods
    df.at[idx, "Neighborhoods"] = ", ".join(municipalities)
```

**Lines 553-561** - Update Umbrella logic:
```python
# Set umbrella region
if is_empty(row["Umbrella"]):
    # If we have municipalities but NO neighborhoods, municipality went to Neighborhoods field
    # so Umbrella should be Allegheny County
    if municipalities and not neighborhoods:
        df.at[idx, "Umbrella"] = "Allegheny County"
    # If we have both or only neighborhoods, look for county in regions
    elif any("county" in r.lower() for r in regions):
        df.at[idx, "Umbrella"] = next(r for r in regions if "county" in r.lower())
    else:
        df.at[idx, "Umbrella"] = "Pittsburgh, Allegheny County"
```

### File: `testing-tool/test_classification.py`

**Lines 9-12** - Fix working directory:
```python
# Add parent to path AND change working directory to project root
project_root = Path(__file__).parent.parent
sys.path.append(str(project_root))
os.chdir(str(project_root))  # CRITICAL: Must run from project root for enhanced_geographic_data.json
```

### File: `testing-tool/backend/test_api.py`

**Already contained fix** at lines 20-25:
```python
# Add parent directory to path to import classification modules
project_root = os.path.join(os.path.dirname(__file__), '..', '..')
sys.path.append(project_root)

# Change to project root directory so relative paths work
original_cwd = os.getcwd()
os.chdir(project_root)
```

## Testing and Validation

### Test Article: Sewickley Black History Story
**URL:** `https://www.publicsource.org/sewickley-black-history-preservation-book-film-fundraising/`

**Classification Results After Fix:**
- ✅ Umbrella: "Allegheny County"
- ✅ Geographic Area: "Northwest Suburbs, North Hills, Mon Valley, East Suburbs"
- ✅ Neighborhoods: "SEWICKLEY, LEET, FOX CHAPEL, SEWICKLEY HEIGHTS, SEWICKLEY HILLS, WALL, CLAIRTON, PENN HILLS, WHITE OAK"
- ✅ All fields populated (no "N/A" or "not detected")

**Confidence Scores:** All detected places have 100% confidence (1.0)

## Data Quality Issues in Existing Database

**The following stories in `frontend/src/data/stories.json` have INCORRECT classifications:**

1. **Story ID 1** (Sewickley) - Line 5-12
   - ❌ Current: `neighborhoods: "Sewickley"`, `geographic_area: "North Side"`
   - ✅ Should be: `neighborhoods: "Sewickley"`, `geographic_area: "Northwest Suburbs"`
   - **Issue:** "North Side" is a Pittsburgh neighborhood region, but Sewickley is a municipality

2. **Story ID 2** (U.S. Steel) - Line 19
   - ❌ Current: `neighborhoods: "Braddock, Clairton"`
   - ✅ Correct: These ARE municipalities (not Pittsburgh neighborhoods), but now OK per new logic

**Note:** These incorrect classifications suggest the original data may have been manually edited or imported from another source with different classification rules.

## Recommendations

### 1. **Reprocess Existing Stories**
Run `reprocess_existing_stories.py` to update all stories with the new classification logic:
```bash
python reprocess_existing_stories.py
```

This will:
- Use the advanced geographic classifier on all existing stories
- Update Umbrella, GeographicArea, and Neighborhoods fields correctly
- Generate confidence scores for all classifications
- Save a detailed analysis to `reprocessing_confidence_analysis.json`

### 2. **Testing Tool Usage**
The standalone testing tool is now working correctly and uses IDENTICAL logic to the main dashboard:

**Start the testing server:**
```bash
cd testing-tool/backend
python test_api.py
```

**Open the frontend:**
Navigate to `testing-tool/frontend/index.html` in a browser

**Test via API:**
```bash
curl -X POST http://localhost:5001/api/test-classify \
  -H "Content-Type: application/json" \
  -d '{"url": "https://www.publicsource.org/article-url/"}'
```

### 3. **Data Validation**
Before deploying the updated classification system:
- Review the `reprocessing_confidence_analysis.json` results
- Spot-check high-profile stories to ensure geographic areas are correct
- Verify that municipalities correctly show their sub_regions (not Pittsburgh regions)

## Technical Architecture Summary

### Classification Pipeline Flow:
```
1. Excel/CSV Upload → Flask API (src/routes/excel_upload.py)
2. → archive_classifier_final.pipeline()
3. → fetch_text() - Web scraping + caching
4. → enhanced_geographic_scan()
5. → advanced_geographic_classifier.AdvancedGeographicClassifier.classify_text()
6. → Returns: found_places list + confidence scores
7. → Assign to fields based on place type:
    - Pittsburgh neighborhoods → Neighborhoods field
    - Municipalities (if no neighborhoods) → Neighborhoods field
    - Regions/sub-regions → GeographicArea field
    - Top-level location → Umbrella field
8. → Save to frontend/src/data/stories.json
9. → Update filters dynamically
```

### Key Files:
- **`archive_classifier_final.py`** - Main classification pipeline
- **`advanced_geographic_classifier.py`** - NLP classification engine
- **`enhanced_geographic_data.json`** - Geographic database (90 neighborhoods + 127 municipalities)
- **`src/routes/excel_upload.py`** - Upload endpoint for main dashboard
- **`testing-tool/backend/test_api.py`** - Standalone testing API (identical logic)
- **`frontend/src/data/stories.json`** - Classified story database

## Questions Answered

### "你使用的逻辑和它真的一样么？" (Are you using the same logic?)

**Answer:**
- **Before today's fix:** NO - the testing tool had working directory issues and couldn't load the geographic database
- **After today's fix:** YES - the testing tool now uses EXACTLY the same pipeline() function and runs from the same directory
- **But:** The existing `stories.json` data was generated with DIFFERENT logic (or manually edited), which is why it had incorrect classifications

### "Geographic area应该是umbrella地下的地区，这是我们目前的逻辑冲突么？"

**Answer:**
- **No conflict** - this is the CORRECT hierarchy and always was intended
- The issue was that previous data had wrong classifications (mixing municipality sub-regions with Pittsburgh neighborhood regions)
- The code now correctly uses:
  - For municipalities: their `sub_region` as GeographicArea
  - For Pittsburgh neighborhoods: their `region` as GeographicArea
- Both are "areas under the umbrella" - they're just from different geographic systems

## Future Improvements

1. **Add validation tests** to ensure municipalities never get classified with Pittsburgh neighborhood regions
2. **Implement confidence threshold filtering** in the UI to allow users to review low-confidence classifications
3. **Add manual override capability** for edge cases where automated classification is incorrect
4. **Create geographic relationship graph visualization** to help users understand the hierarchy
5. **Consider merging similar sub-regions** (e.g., "Northwest suburbs" vs "Northwest Suburbs" capitalization)

## Contact

For questions about this classification system, refer to:
- Main pipeline: `archive_classifier_final.py`
- NLP classifier: `advanced_geographic_classifier.py`
- Geographic data: `enhanced_geographic_data.json`
- This notes file: `IMPORTANT_NOTES.md`

---

**Last Updated:** 2025-01-15
**Classification System Version:** 2.0 (with municipality support in Neighborhoods field)
**Status:** ✅ Tested and Working
